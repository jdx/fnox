#!/usr/bin/env bash
#MISE description="Generate editorialized release notes using Claude Code"
#USAGE arg "<version>" help="Version to release (e.g., v1.9.0)"
#USAGE arg "[prev_version]" help="Previous version for comparison"
set -euo pipefail

version="${usage_version:-}"
prev_version="${usage_prev_version:-}"

if [[ -z $version ]]; then
	echo "Usage: mise run gen-release-summary <version> [prev_version]" >&2
	exit 1
fi

# Get the git-cliff changelog for context
changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")

if [[ -z $changelog ]]; then
	echo "Error: No unreleased changes found" >&2
	exit 1
fi

# Build prompt safely using printf to avoid command substitution on backticks in changelog
prompt=$(
	printf '%s\n' "You are writing release notes for fnox version ${version}${prev_version:+ (previous version: ${prev_version})}."
	printf '\n'
	printf '%s\n' "fnox is a secrets management CLI that encrypts and manages secrets in config files, supporting multiple providers (1Password, AWS, Azure, GCP, Bitwarden, etc.)."
	printf '\n'
	printf '%s\n' "Here is the raw changelog from git-cliff:"
	printf '%s\n' "$changelog"
	printf '\n'
	cat <<'INSTRUCTIONS'
Rewrite this into user-friendly release notes. The format should be:

1. Start with 1-2 paragraphs summarizing the most important changes
2. Then organize into sections using ### headers (e.g., "### Highlights", "### Bug Fixes")
3. Write in clear, user-focused language (not developer commit messages)
4. Explain WHY changes matter to users, not just what changed
5. Group related changes together logically
6. Skip minor/internal changes that don't affect users
7. Include contributor attribution where appropriate (@username)
8. Include links to PRs (e.g., [#123](https://github.com/jdx/fnox/pull/123)) for significant changes
9. Where applicable, link to relevant documentation at https://fnox.jdx.dev/

IMPORTANT: Use only ### for section headers. NEVER use "## [" as this pattern is reserved for version headers and will corrupt changelog processing.

Keep the tone professional but approachable. Focus on what users care about.

Output ONLY the editorialized release notes, no preamble.
INSTRUCTIONS
)

# Use Claude Code to editorialize the release notes
# Sandboxed: only read-only tools allowed (no Bash, Edit, Write)
output=$(
	printf '%s' "$prompt" | claude -p \
		--model claude-sonnet-4-20250514 \
		--output-format text \
		--allowedTools "Read,Grep,Glob"
)

# Validate output doesn't contain patterns that would corrupt changelog processing
if echo "$output" | grep -qE '^## \['; then
	echo "Error: LLM output contains '## [' pattern which would corrupt changelog processing" >&2
	exit 1
fi

echo "$output"
